#!/usr/bin/env bash


# Autonity client releases are available here:
# https://github.com/autonity/autonity/releases
AUTONITY_NODE_COMMIT=${AUTONITY_NODE_COMMIT:=ce483153e7c1527c0326e8100b57b102bd702781}
AUTONITY_NODE_REPO=${AUTONITY_NODE_REPO:=https://github.com/autonity/autonity.git}

echo
echo "============================================================"
echo "Generating ABI files for Autonity contract from:"
echo "Repository: ${AUTONITY_NODE_REPO}"
echo "Commit:     ${AUTONITY_NODE_COMMIT}"
echo "============================================================"


# check for required commands
command -v truffle >/dev/null 2>&1 || { echo >&2 "truffle command was not found"; exit 1; }
command -v jq >/dev/null 2>&1 || { echo >&2 "jq command was not found"; exit 1; }

# clone the autonity repository
echo "cloning the repository"
WORKING_DIR=temp
mkdir -p ${WORKING_DIR}
git clone ${AUTONITY_NODE_REPO} ${WORKING_DIR}/autonity
git -C ${WORKING_DIR}/autonity checkout ${AUTONITY_NODE_COMMIT}

# Compile the contracts
echo "compiling the contracts"
pushd ${WORKING_DIR}/autonity/autonity/solidity > /dev/null
truffle compile | grep "solc:" > solc-version.txt
popd > /dev/null

# create target directory
mkdir -p autonity/abi

# extract abi from json files
echo "processing abi files"
contracts=( Autonity IOracle )
for i in "${contracts[@]}"
do
	cat ${WORKING_DIR}/autonity/autonity/solidity/build/contracts/${i}.json | jq --sort-keys .abi > autonity/abi/${i}.abi
done

# Record how the abi was generated
echo "recording abi generation details"
mv ${WORKING_DIR}/autonity/autonity/solidity/solc-version.txt autonity/abi/solc-version.txt
git -C ${WORKING_DIR}/autonity log --no-decorate --pretty='format:%H' -n 1 > autonity/abi/autonity-commit.txt


# cleanup
echo "cleaning up"
rm -rf ${WORKING_DIR}

echo
echo "============================================================"
echo "ABI files written to directory abi.  Test and commit to git."
echo "============================================================"
